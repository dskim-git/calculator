# main.py
import math
import numpy as np
import pandas as pd
import streamlit as st
import plotly.graph_objects as go
import plotly.express as px

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê¸°ë³¸ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="ìˆ˜í•™ ê³„ì‚°ê¸° & ì„¸ê³„ì¸êµ¬ ë¶„ì„",
    page_icon="ðŸ§®",
    layout="centered",
)

st.title("ðŸ§® ìˆ˜í•™ ê³„ì‚°ê¸° & ðŸŒ ì„¸ê³„ì¸êµ¬ ë¶„ì„ ì›¹ì•±")
st.write("ì‚¬ì¹™ì—°ì‚°, ëª¨ë“ˆëŸ¬, ì§€ìˆ˜, ë¡œê·¸, ë‹¤í•­í•¨ìˆ˜ ê·¸ëž˜í”„, ì—°ë„ë³„ ì„¸ê³„ì¸êµ¬ ë¶„ì„ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì‚¬ì´ë“œë°” ë©”ë‰´
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
menu = st.sidebar.selectbox(
    "ê¸°ëŠ¥ ì„ íƒ",
    [
        "ì‚¬ì¹™ì—°ì‚°",
        "ëª¨ë“ˆëŸ¬ ì—°ì‚° (a mod n)",
        "ì§€ìˆ˜ ì—°ì‚° (a^b)",
        "ë¡œê·¸ ì—°ì‚° (log_b(a))",
        "ë‹¤í•­í•¨ìˆ˜ ê·¸ëž˜í”„",
        "ì—°ë„ë³„ ì„¸ê³„ì¸êµ¬ ë¶„ì„",
    ],
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 0. ê³µìš© í•¨ìˆ˜: ì„¸ê³„ ì¸êµ¬ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@st.cache_data
def load_population_data():
    """
    world_population.csv íŒŒì¼ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
    ì˜ˆìƒ ì»¬ëŸ¼:
      - code (ISO3 êµ­ê°€ ì½”ë“œ)
      - Country
      - 1970, 1980, 1990, 2000, 2010, 2015, 2020, 2022
      - World Population Percentage
    """
    df = pd.read_csv("world_population.csv")
    df.columns = [c.strip() for c in df.columns]  # í˜¹ì‹œ ëª¨ë¥¼ ê³µë°± ì œê±°
    return df


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1ï¸âƒ£ ì‚¬ì¹™ì—°ì‚°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if menu == "ì‚¬ì¹™ì—°ì‚°":
    st.subheader("ì‚¬ì¹™ì—°ì‚°")

    op = st.selectbox(
        "ì—°ì‚° ì„ íƒ",
        ["ë§ì…ˆ (+)", "ëº„ì…ˆ (-)", "ê³±ì…ˆ (Ã—)", "ë‚˜ëˆ—ì…ˆ (Ã·)"],
    )

    a = st.number_input("ì²« ë²ˆì§¸ ìˆ˜ a", value=0.0)
    b = st.number_input("ë‘ ë²ˆì§¸ ìˆ˜ b", value=0.0)

    if st.button("ê³„ì‚°í•˜ê¸°", key="basic"):
        result = None
        latex = ""

        if op == "ë§ì…ˆ (+)":
            result = a + b
            latex = f"{a} + {b} = {result}"

        elif op == "ëº„ì…ˆ (-)":
            result = a - b
            latex = f"{a} - {b} = {result}"

        elif op == "ê³±ì…ˆ (Ã—)":
            result = a * b
            latex = f"{a} \\times {b} = {result}"

        else:  # ë‚˜ëˆ—ì…ˆ
            if b == 0:
                st.error("0ìœ¼ë¡œ ë‚˜ëˆŒ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            else:
                result = a / b
                latex = f"{a} \\div {b} = {result}"

        if result is not None:
            st.success("âœ… ê³„ì‚° ê²°ê³¼")
            st.latex(latex)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2ï¸âƒ£ ëª¨ë“ˆëŸ¬ ì—°ì‚°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
elif menu == "ëª¨ë“ˆëŸ¬ ì—°ì‚° (a mod n)":
    st.subheader("ëª¨ë“ˆëŸ¬ ì—°ì‚° (a mod n)")

    a = int(st.number_input("ì •ìˆ˜ a", value=10, step=1))
    n = int(st.number_input("ì–‘ì˜ ì •ìˆ˜ n", value=3, min_value=1, step=1))

    if st.button("ê³„ì‚°í•˜ê¸°", key="mod"):
        result = a % n
        st.success("âœ… ê³„ì‚° ê²°ê³¼")
        st.latex(f"{a} \\bmod {n} = {result}")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3ï¸âƒ£ ì§€ìˆ˜ ì—°ì‚°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
elif menu == "ì§€ìˆ˜ ì—°ì‚° (a^b)":
    st.subheader("ì§€ìˆ˜ ì—°ì‚° (a^b)")

    a = st.number_input("ë°‘ a", value=2.0)
    b = st.number_input("ì§€ìˆ˜ b", value=3.0)

    if st.button("ê³„ì‚°í•˜ê¸°", key="power"):
        try:
            result = a ** b
            st.success("âœ… ê³„ì‚° ê²°ê³¼")
            st.latex(f"{a}^{{{b}}} = {result}")
        except OverflowError:
            st.error("ê°’ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. ì§€ìˆ˜ë¥¼ ì¤„ì—¬ë³´ì„¸ìš”.")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4ï¸âƒ£ ë¡œê·¸ ì—°ì‚°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
elif menu == "ë¡œê·¸ ì—°ì‚° (log_b(a))":
    st.subheader("ë¡œê·¸ ì—°ì‚° (log_b(a))")

    x = st.number_input("ì§„ìˆ˜ a (>0)", value=8.0)
    b = st.number_input("ë°‘ b (>0, bâ‰ 1)", value=2.0)

    if st.button("ê³„ì‚°í•˜ê¸°", key="log"):
        if x <= 0:
            st.error("aëŠ” 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.")
        elif b <= 0 or b == 1:
            st.error("bëŠ” 0ë³´ë‹¤ í¬ê³  1ì´ ì•„ë‹ˆì–´ì•¼ í•©ë‹ˆë‹¤.")
        else:
            result = math.log(x, b)
            st.success("âœ… ê³„ì‚° ê²°ê³¼")
            st.latex(f"\\log_{{{b}}} {x} = {result}")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5ï¸âƒ£ ë‹¤í•­í•¨ìˆ˜ ê·¸ëž˜í”„ (Plotly)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
elif menu == "ë‹¤í•­í•¨ìˆ˜ ê·¸ëž˜í”„":
    st.subheader("ðŸ“ˆ ë‹¤í•­í•¨ìˆ˜ ê·¸ëž˜í”„ ê·¸ë¦¬ê¸°")

    degree = st.selectbox("ë‹¤í•­ì‹ ì°¨ìˆ˜ ì„ íƒ", [1, 2, 3])

    if degree == 1:
        a = st.number_input("a (1ì°¨í•­ ê³„ìˆ˜)", value=1.0)
        b = st.number_input("b (ìƒìˆ˜í•­)", value=0.0)
        st.latex(f"f(x) = {a}x + {b}")
        f = lambda x: a * x + b

    elif degree == 2:
        a = st.number_input("a (2ì°¨í•­ ê³„ìˆ˜)", value=1.0)
        b = st.number_input("b (1ì°¨í•­ ê³„ìˆ˜)", value=0.0)
        c = st.number_input("c (ìƒìˆ˜í•­)", value=0.0)
        st.latex(f"f(x) = {a}x^2 + {b}x + {c}")
        f = lambda x: a * x**2 + b * x + c

    else:  # 3ì°¨
        a = st.number_input("a (3ì°¨í•­ ê³„ìˆ˜)", value=1.0)
        b = st.number_input("b (2ì°¨í•­ ê³„ìˆ˜)", value=0.0)
        c = st.number_input("c (1ì°¨í•­ ê³„ìˆ˜)", value=0.0)
        d = st.number_input("d (ìƒìˆ˜í•­)", value=0.0)
        st.latex(f"f(x) = {a}x^3 + {b}x^2 + {c}x + {d}")
        f = lambda x: a * x**3 + b * x**2 + c * x + d

    x_min, x_max = st.slider("x ë²”ìœ„ ì„¤ì •", -20, 20, (-5, 5))

    if st.button("ê·¸ëž˜í”„ ê·¸ë¦¬ê¸°", key="poly_plot"):
        x = np.linspace(x_min, x_max, 400)
        y = f(x)

        fig = go.Figure()
        fig.add_trace(go.Scatter(x=x, y=y, mode="lines", name="f(x)"))

        fig.update_layout(
            title="ë‹¤í•­í•¨ìˆ˜ ê·¸ëž˜í”„",
            xaxis_title="x",
            yaxis_title="f(x)",
        )

        st.plotly_chart(fig, use_container_width=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6ï¸âƒ£ ì—°ë„ë³„ ì„¸ê³„ì¸êµ¬ ë¶„ì„
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
elif menu == "ì—°ë„ë³„ ì„¸ê³„ì¸êµ¬ ë¶„ì„":
    st.subheader("ðŸŒ ì—°ë„ë³„ ì„¸ê³„ì¸êµ¬ ë¶„ì„")

    # ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    try:
        df_pop = load_population_data()
    except FileNotFoundError:
        st.error("world_population.csv íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. main.pyì™€ ê°™ì€ í´ë”ì— ë‘ê³  ë‹¤ì‹œ ì‹¤í–‰í•´ ì£¼ì„¸ìš”.")
        st.stop()

    # ì—°ë„ ëª©ë¡ (CSV ì»¬ëŸ¼ ì´ë¦„ì— ë§žì¶° ì‚¬ìš©)
    year_columns = ["1970", "1980", "1990", "2000", "2010", "2015", "2020", "2022"]

    st.markdown("#### 1) ì—°ë„ë³„ ì„¸ê³„ ì¸êµ¬ ì§€ë„")

    year = st.selectbox(
        "ì—°ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”",
        options=year_columns,
        format_func=lambda y: f"{y}ë…„"
    )

    # ì„ íƒí•œ ì—°ë„ì˜ ì¸êµ¬ ì§€ë„
    if st.button("ì„ íƒ ì—°ë„ ì¸êµ¬ ì§€ë„ ë³´ê¸°", key="year_map"):
        fig_year = px.choropleth(
            df_pop,
            locations="code",          # ISO3 êµ­ê°€ ì½”ë“œ
            color=year,
            hover_name="Country",
            color_continuous_scale="Viridis",
            labels={year: f"Population {year}"},
        )
        fig_year.update_layout(
            title=f"{year}ë…„ ì„¸ê³„ ì¸êµ¬ ë¶„í¬",
        )
        st.plotly_chart(fig_year, use_container_width=True)

    st.markdown("---")
    st.markdown("#### 2) ì„¸ê³„ ì¸êµ¬ ë¹„ìœ¨(%) ì§€ë„")

    st.write("ê° ë‚˜ë¼ê°€ ì „ ì„¸ê³„ ì¸êµ¬ì—ì„œ ì°¨ì§€í•˜ëŠ” **ë¹„ìœ¨(%)**ì„ ìƒ‰ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.")

    if "World Population Percentage" not in df_pop.columns:
        st.error("'World Population Percentage' ì—´ì´ CSVì— ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
    else:
        if st.button("ì„¸ê³„ ì¸êµ¬ ë¹„ìœ¨ ì§€ë„ ë³´ê¸°", key="share_map"):
            fig_share = px.choropleth(
                df_pop,
                locations="code",
                color="World Population Percentage",
                hover_name="Country",
                color_continuous_scale="Plasma",
                labels={"World Population Percentage": "World Population %"},
            )
            fig_share.update_layout(
                title="ì„¸ê³„ ì¸êµ¬ ë¹„ìœ¨(%) ë¶„í¬",
            )
            st.plotly_chart(fig_share, use_container_width=True)

    with st.expander("ðŸ“„ ë°ì´í„° ì¼ë¶€ ë¯¸ë¦¬ë³´ê¸°"):
        st.dataframe(df_pop.head())

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì‚¬ìš© ì•ˆë‚´ ê³µí†µ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.expander("â„¹ï¸ ì‚¬ìš© ì•ˆë‚´"):
    st.markdown(
        """
        - **ì‚¬ì¹™ì—°ì‚°**: ë‘ ìˆ˜ì— ëŒ€í•œ ê¸°ë³¸ ì—°ì‚°  
        - **ëª¨ë“ˆëŸ¬ ì—°ì‚°**: a mod n (ë‚˜ë¨¸ì§€ ì—°ì‚°)  
        - **ì§€ìˆ˜ ì—°ì‚°**: \(a^b\) ê³„ì‚°  
        - **ë¡œê·¸ ì—°ì‚°**: \(\log_b a\) ê³„ì‚°  
        - **ë‹¤í•­í•¨ìˆ˜ ê·¸ëž˜í”„**: 1~3ì°¨ ë‹¤í•­í•¨ìˆ˜ì˜ ê·¸ëž˜í”„ë¥¼ Plotlyë¡œ ì‹œê°í™”  
        - **ì—°ë„ë³„ ì„¸ê³„ì¸êµ¬ ë¶„ì„**:  
          - ì„ íƒí•œ ì—°ë„ì˜ ì¸êµ¬ìˆ˜ë¥¼ ì„¸ê³„ì§€ë„(choropleth)ë¡œ ì‹œê°í™”  
          - ê° ë‚˜ë¼ì˜ ì„¸ê³„ ì¸êµ¬ ë¹„ìœ¨(%)ì„ ìƒ‰ìœ¼ë¡œ í‘œí˜„  
        """
    )

if __name__ == "__main__":
    # streamlit run main.py ë¡œ ì‹¤í–‰
    pass
